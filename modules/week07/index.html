<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Week 7: API Integration &amp; Caching | MAD9124</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="Full-stack: API Development">
    
    <link rel="preload" href="/s2024/assets/css/0.styles.70738741.css" as="style"><link rel="preload" href="/s2024/assets/js/app.40d35fb0.js" as="script"><link rel="preload" href="/s2024/assets/js/2.d13f26af.js" as="script"><link rel="preload" href="/s2024/assets/js/1.f6f71081.js" as="script"><link rel="preload" href="/s2024/assets/js/35.d62ca566.js" as="script"><link rel="preload" href="/s2024/assets/js/32.baab7363.js" as="script"><link rel="prefetch" href="/s2024/assets/js/10.700b6097.js"><link rel="prefetch" href="/s2024/assets/js/11.ed8a0934.js"><link rel="prefetch" href="/s2024/assets/js/12.9b4b523d.js"><link rel="prefetch" href="/s2024/assets/js/13.07dd1a9d.js"><link rel="prefetch" href="/s2024/assets/js/14.b96c24af.js"><link rel="prefetch" href="/s2024/assets/js/15.b144383e.js"><link rel="prefetch" href="/s2024/assets/js/16.d16dea2a.js"><link rel="prefetch" href="/s2024/assets/js/17.b4e1a4e8.js"><link rel="prefetch" href="/s2024/assets/js/18.1f2ac466.js"><link rel="prefetch" href="/s2024/assets/js/19.e668708c.js"><link rel="prefetch" href="/s2024/assets/js/20.4f30b3de.js"><link rel="prefetch" href="/s2024/assets/js/21.248f91f3.js"><link rel="prefetch" href="/s2024/assets/js/22.29f49c1a.js"><link rel="prefetch" href="/s2024/assets/js/23.b8ac89c9.js"><link rel="prefetch" href="/s2024/assets/js/24.e2934475.js"><link rel="prefetch" href="/s2024/assets/js/25.fce0b0a1.js"><link rel="prefetch" href="/s2024/assets/js/26.de8d994d.js"><link rel="prefetch" href="/s2024/assets/js/27.c7ef8247.js"><link rel="prefetch" href="/s2024/assets/js/28.75604c91.js"><link rel="prefetch" href="/s2024/assets/js/29.1b506275.js"><link rel="prefetch" href="/s2024/assets/js/3.8c4cc701.js"><link rel="prefetch" href="/s2024/assets/js/30.787c7c10.js"><link rel="prefetch" href="/s2024/assets/js/31.e47a0c3f.js"><link rel="prefetch" href="/s2024/assets/js/33.aa620044.js"><link rel="prefetch" href="/s2024/assets/js/34.81206c0b.js"><link rel="prefetch" href="/s2024/assets/js/36.1835e393.js"><link rel="prefetch" href="/s2024/assets/js/37.5098b7b5.js"><link rel="prefetch" href="/s2024/assets/js/38.3ddeba96.js"><link rel="prefetch" href="/s2024/assets/js/39.3f5b8ef9.js"><link rel="prefetch" href="/s2024/assets/js/4.a03d1287.js"><link rel="prefetch" href="/s2024/assets/js/40.b63f2a79.js"><link rel="prefetch" href="/s2024/assets/js/41.5cb461bc.js"><link rel="prefetch" href="/s2024/assets/js/42.fcb0df3f.js"><link rel="prefetch" href="/s2024/assets/js/43.3a92d7d8.js"><link rel="prefetch" href="/s2024/assets/js/44.5c466f1c.js"><link rel="prefetch" href="/s2024/assets/js/45.c7c3dc1a.js"><link rel="prefetch" href="/s2024/assets/js/46.286df3e7.js"><link rel="prefetch" href="/s2024/assets/js/47.8363bb83.js"><link rel="prefetch" href="/s2024/assets/js/48.56c3e93e.js"><link rel="prefetch" href="/s2024/assets/js/49.b0be2d4e.js"><link rel="prefetch" href="/s2024/assets/js/5.ed6c1368.js"><link rel="prefetch" href="/s2024/assets/js/50.b89e2a53.js"><link rel="prefetch" href="/s2024/assets/js/51.7249e197.js"><link rel="prefetch" href="/s2024/assets/js/52.87fc5cdd.js"><link rel="prefetch" href="/s2024/assets/js/53.56f24714.js"><link rel="prefetch" href="/s2024/assets/js/54.fae6ee81.js"><link rel="prefetch" href="/s2024/assets/js/55.b1e6a4dd.js"><link rel="prefetch" href="/s2024/assets/js/56.eadf21bf.js"><link rel="prefetch" href="/s2024/assets/js/57.d912e614.js"><link rel="prefetch" href="/s2024/assets/js/6.45d9b7e6.js"><link rel="prefetch" href="/s2024/assets/js/7.017a2e0d.js"><link rel="prefetch" href="/s2024/assets/js/vendors~docsearch.38838867.js">
    <link rel="stylesheet" href="/s2024/assets/css/0.styles.70738741.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/s2024/" class="home-link router-link-active"><!----> <span class="site-name">MAD9124</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/s2024/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/s2024/modules/" class="nav-link router-link-active">
  Modules
</a></div><div class="nav-item"><a href="/s2024/deliverables/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/s2024/resources/" class="nav-link">
  Resources
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/s2024/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/s2024/modules/" class="nav-link router-link-active">
  Modules
</a></div><div class="nav-item"><a href="/s2024/deliverables/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/s2024/resources/" class="nav-link">
  Resources
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Introduction</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Content Modules</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/s2024/modules/" aria-current="page" class="sidebar-link">Table of contents</a></li><li><a href="/s2024/modules/week01/" class="sidebar-link">Week 1: Introduction &amp; Review</a></li><li><a href="/s2024/modules/week02/" class="sidebar-link">Week 2: Node Modules &amp; Express</a></li><li><a href="/s2024/modules/week03/" class="sidebar-link">Week 3: APIs</a></li><li><a href="/s2024/modules/week04/" class="sidebar-link">Week 4: Project Structure, RESTful alternatives, and Postman</a></li><li><a href="/s2024/modules/week05/" class="sidebar-link">Week 5: Middleware</a></li><li><a href="/s2024/modules/week06/" class="sidebar-link">Week 6: Midterm Project</a></li><li><a href="/s2024/modules/week07/" aria-current="page" class="active sidebar-link">Week 7: API Integration &amp; Caching</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/s2024/modules/week07/#agenda" class="sidebar-link">Agenda</a></li><li class="sidebar-sub-header"><a href="/s2024/modules/week07/#what-is-api-integration" class="sidebar-link">What is API Integration?</a></li><li class="sidebar-sub-header"><a href="/s2024/modules/week07/#getting-api-access" class="sidebar-link">Getting API access</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/s2024/modules/week07/#rate-limits" class="sidebar-link">Rate Limits</a></li><li class="sidebar-sub-header"><a href="/s2024/modules/week07/#let-s-explore" class="sidebar-link">Let's Explore!</a></li></ul></li><li class="sidebar-sub-header"><a href="/s2024/modules/week07/#integrating-into-our-code" class="sidebar-link">Integrating into our code</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/s2024/modules/week07/#creating-the-weatherservice" class="sidebar-link">Creating the WeatherService</a></li><li class="sidebar-sub-header"><a href="/s2024/modules/week07/#using-axios" class="sidebar-link">Using Axios</a></li></ul></li><li class="sidebar-sub-header"><a href="/s2024/modules/week07/#dotenv" class="sidebar-link">Dotenv</a></li><li class="sidebar-sub-header"><a href="/s2024/modules/week07/#caching" class="sidebar-link">Caching</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/s2024/modules/week07/#what-is-a-cache" class="sidebar-link">What is a Cache?</a></li><li class="sidebar-sub-header"><a href="/s2024/modules/week07/#basic-in-memory-cache" class="sidebar-link">Basic in memory Cache</a></li></ul></li><li class="sidebar-sub-header"><a href="/s2024/modules/week07/#redis" class="sidebar-link">Redis</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/s2024/modules/week07/#installing-redis-on-your-system" class="sidebar-link">Installing Redis on your system</a></li><li class="sidebar-sub-header"><a href="/s2024/modules/week07/#installing-redis-in-our-application" class="sidebar-link">Installing redis in our application</a></li><li class="sidebar-sub-header"><a href="/s2024/modules/week07/#more-information" class="sidebar-link">More information</a></li></ul></li></ul></li><li><a href="/s2024/modules/break-week/" class="sidebar-link">Break Week</a></li><li><a href="/s2024/modules/week09/" class="sidebar-link">Week 9: Data Persitance and MongoDB</a></li><li><a href="/s2024/modules/week10/" class="sidebar-link">Week 10: Object Data Modelling with Mongoose</a></li><li><a href="/s2024/modules/week11/" class="sidebar-link">Week 11: Data Santization, XSS and LoggingS</a></li><li><a href="/s2024/modules/week12/" class="sidebar-link">Week 12: Authentication With Passport</a></li><li><a href="/s2024/modules/week13/" class="sidebar-link">Week 13: Testing with Jest</a></li><li><a href="/s2024/modules/week14/" class="sidebar-link">Week 14: Preparing for Production</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1><span class="week">Week 7</span><br> <span class="title">API Integration &amp; Caching</span></h1> <h2 id="agenda"><a href="#agenda" class="header-anchor">#</a> Agenda</h2> <ul><li>AMA</li> <li>What is API Integration?</li> <li>Getting API access</li> <li>Integrating into our code</li> <li>Dotenv</li> <li>Caching</li> <li>Redis</li></ul> <h2 id="what-is-api-integration"><a href="#what-is-api-integration" class="header-anchor">#</a> What is API Integration?</h2> <p>An <strong>API Integration</strong> is the connection between two or more applications, using their APIs, that let the systems exchange data. They are a powerful way to keep data in sync, reduce development time, and enhance productivity.</p> <h4 id="example-using-the-weather-api"><a href="#example-using-the-weather-api" class="header-anchor">#</a> Example: Using the Weather API</h4> <p>Lets say we have an application that keeps track of walks taken with our dog. We'd like to add what the weather was like during our walk. We can integrate with the <a href="https://www.weatherapi.com/" target="_blank" rel="noopener noreferrer">Weather API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to add the weather at the time of our walk!</p> <h2 id="getting-api-access"><a href="#getting-api-access" class="header-anchor">#</a> Getting API access</h2> <p>Most APIs have some sort of authentication protecting them, so we will need to register to gain access.
Go to [https://www.weatherapi.com/signup.aspx] and sign up to get the credentials we will need.</p> <p><img src="/s2024/assets/img/weather-signup.2e97378c.png" alt="weather signup"></p> <p>Copy the API Key found on your dashboard
<img src="/s2024/assets/img/weather-key.5c4cd729.png" alt="weather api key"></p> <h3 id="rate-limits"><a href="#rate-limits" class="header-anchor">#</a> Rate Limits</h3> <p>To protect their severs from being over run, and to make money, most APIs limit the amount of requests, or type of data that a user can receive. This is called a <strong>Rate Limit</strong>. Luckily, the Weather API has a fairly generous free tier, that should be more an enough for this class.</p> <h3 id="let-s-explore"><a href="#let-s-explore" class="header-anchor">#</a> Let's Explore!</h3> <p>Click on API Explorer, and test out what kind of data we can get from the Weather API. We care about the History API, since we will be uploading historical walks. Lets do a test request for Ottawa on 2024-06-20, and see what data we have access to.</p> <h4 id="that-s-a-lot-of-data"><a href="#that-s-a-lot-of-data" class="header-anchor">#</a> That's a lot of Data!</h4> <p>For our application, we will add the temperature and precipitation to our walk, and to keep things simple, we will use the daily averages for each.
These are found at:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>forecast<span class="token punctuation">.</span>forecastday<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>day<span class="token punctuation">.</span>avgtemp_c<span class="token punctuation">,</span>
  forecast<span class="token punctuation">.</span>forecastday<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>day<span class="token punctuation">.</span>totalprecip_mm<span class="token punctuation">;</span>
</code></pre></div><h2 id="integrating-into-our-code"><a href="#integrating-into-our-code" class="header-anchor">#</a> Integrating into our code</h2> <p>You can find the starter code <a href="https://storage.googleapis.com/crapper-images/walkAPI.zip" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="creating-the-weatherservice"><a href="#creating-the-weatherservice" class="header-anchor">#</a> Creating the WeatherService</h3> <p>It is best practice to separate our code into different files. This keeps things localized, easier to read, and more manageable.</p> <p>I like to create different services for my code. Each service is in charge of exactly <em>one thing</em>, and anything that has to to do with that <em>one thing</em> belongs to the service.</p> <h3 id="using-axios"><a href="#using-axios" class="header-anchor">#</a> Using Axios</h3> <p>Axios is a popular npm package for making http request from a Node server. We will use it to make our requests to the Weather API.</p> <div class="language-sh extra-class"><pre class="language-sh"><code>    <span class="token function">npm</span> i axios
</code></pre></div><p>Axios has an asynchronous <code>get</code> method that allows us to make GET requests to a given url. Let's try it out:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// test.js</span>
<span class="token keyword">const</span> axios <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'axios'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">axiosTest</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
    <span class="token string">'https://api.weatherapi.com/v1/history.json?key=[your-api-here]&amp;q=Ottawa&amp;dt=2024-06-18'</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">axiosTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>That's more data than we need, lets destructure the data from the response, and wrap it in a try/catch block to handle any errors.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// test.js</span>
<span class="token keyword">const</span> axios <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'axios'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">axiosTest</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
      <span class="token string">'https://api.weatherapi.com/v1/history.json?key=[your-api-here]&amp;q=Ottawa&amp;dt=2024-06-20'</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// we can take only the information we care about like so:</span>
    <span class="token keyword">const</span> weatherData <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">temperature</span><span class="token operator">:</span> data<span class="token punctuation">.</span>forecast<span class="token punctuation">.</span>forecastday<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>day<span class="token punctuation">.</span>avgtemp_c<span class="token punctuation">,</span>
      <span class="token literal-property property">precipitation</span><span class="token operator">:</span> data<span class="token punctuation">.</span>forecast<span class="token punctuation">.</span>forecastday<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>day<span class="token punctuation">.</span>totalprecip_mm<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>weatherData<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// some sort of error handling</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">axiosTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="we-ve-got-the-data-now-lets-use-it"><a href="#we-ve-got-the-data-now-lets-use-it" class="header-anchor">#</a> We've got the data, now lets use it</h4> <p>We can import axios into our WeatherService to make api requests to the Weather API. We will also be exporting a method getWeather, with the parameters <code>city</code> and <code>startTime</code>. We will send these to the Weather API to get the weather data that we need.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// src/controllers/weatherService.js</span>

<span class="token keyword">const</span> axios <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'axios'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">getWeather</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">city<span class="token punctuation">,</span> startTime</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  getWeather<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>We will need our access token provided by the Weather API. Let's store it in a constant variable.
We can add query parameters to our request using the axios config to match how the Weather API expects the data.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// src/controllers/weatherService.js</span>

<span class="token keyword">const</span> axios <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'axios'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">API_KEY</span> <span class="token operator">=</span> <span class="token string">'[your-api-key]'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">getWeather</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">city<span class="token punctuation">,</span> startTime</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
      <span class="token string">'https://api.weatherapi.com/v1/history.json'</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">params</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token constant">API_KEY</span><span class="token punctuation">,</span>
          <span class="token literal-property property">q</span><span class="token operator">:</span> city<span class="token punctuation">,</span>
          <span class="token literal-property property">dt</span><span class="token operator">:</span> startTime<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> weatherData <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">temperature</span><span class="token operator">:</span> data<span class="token punctuation">.</span>forecast<span class="token punctuation">.</span>forecastday<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>day<span class="token punctuation">.</span>avgtemp_c<span class="token punctuation">,</span>
      <span class="token literal-property property">precipitation</span><span class="token operator">:</span> data<span class="token punctuation">.</span>forecast<span class="token punctuation">.</span>forecastday<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>day<span class="token punctuation">.</span>totalprecip_mm<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> weatherData<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// for now, we will override all errors with our own 400 error.</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'400|Bad request to Weather API'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  getWeather<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Our WeatherService method is working! We can now import it into our walkService, and add the extra data to our walk response when creating a new walk.</p> <div class="custom-block warning"><p class="custom-block-title">weatherApi.getWeather is Asynchronous!!!</p> <p>Since axios methods take time to get a response, we need to use Promises to capture the data.
We can use async / await to add it to our service without too much trouble</p></div> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// src/services/walk.js</span>

<span class="token comment">// don't forget to import the weatherService!!!</span>
<span class="token keyword">const</span> weatherService <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../services/weather'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">create</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">body</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> startTime<span class="token punctuation">,</span> endTime<span class="token punctuation">,</span> city <span class="token punctuation">}</span> <span class="token operator">=</span> body<span class="token punctuation">;</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>startTime <span class="token operator">||</span> <span class="token operator">!</span>endTime <span class="token operator">||</span> <span class="token operator">!</span>city<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'400|Invalid input'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Once we pass our validation, we can send the city and startTime to our weatherService,</span>
  <span class="token comment">// to get the weather information for the city and time of our walk.</span>
  <span class="token keyword">const</span> weather <span class="token operator">=</span> <span class="token keyword">await</span> weatherService<span class="token punctuation">.</span><span class="token function">getWeather</span><span class="token punctuation">(</span>city<span class="token punctuation">,</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> newWalk <span class="token operator">=</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">,</span>
    <span class="token literal-property property">startTime</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">endTime</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>endTime<span class="token punctuation">)</span><span class="token punctuation">,</span>
    city<span class="token punctuation">,</span>
    weather<span class="token punctuation">,</span> <span class="token comment">// add the weather information here</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  walks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newWalk<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> newWalk<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">Async / Await</p> <p>Don't forget to add async / await to our controller method as well!!!
Async functions always return a promise, so whenever we use this create function now (ie, walkController.create), we will have to use async / await there as well.</p></div> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">create</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newWalk <span class="token operator">=</span> <span class="token keyword">await</span> walkService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> newWalk<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="dotenv"><a href="#dotenv" class="header-anchor">#</a> Dotenv</h2> <p>It is very important not to write secret values directly in our code. The <code>API_KEY</code> we are using was given to us by the WeatherAPI, and it is meant for us and only us to use. If we leave it as written currently, and commit to git, it will be public for anyone in the world to take and use. This can be especially harmful once we start using database passwords, or if your api key is paid per request, a malicious attacker could use our key, and you would have to pay for it!</p> <p>To hide our sensitive information, we can use <code>ENVIRONMENT VARIABLES</code>, accessible in <code>process.env</code>.</p> <p>An environment variable is a variable whose value is set outside the program, typically through functionality built into the operating system or microservice. An environment variable is made up of a name/value pair, and any number may be created and available for reference at a point in time.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">API_KEY</span> <span class="token punctuation">}</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">;</span>
</code></pre></div><p>There is a library <code>dotenv</code> that will take a special file called <code>.env</code>, and automatically add all the values from the file as environment files to our node application.</p> <p>Install the library:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i dotenv
</code></pre></div><p>And add it to the very top of our index.js file. We can simply require the configuration function, and it will set everything up for us!</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// index.js</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dotenv/config'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// .env</span>
<span class="token constant">PORT</span><span class="token operator">=</span><span class="token number">4000</span>
<span class="token constant">API_KEY</span><span class="token operator">=</span>91ij08<span class="token operator">-</span>1fehi<span class="token operator">=</span>1feef
</code></pre></div><p>With this easy setup, we can easily keep track of our environment variables!</p> <div class="custom-block warning"><p class="custom-block-title">MAKE SURE TO ADD .env TO YOUR .gitignore FILE!!!!!</p> <p><code>.env</code> files often contain sensitive information that shouldn't be shared with github, and should not be committed. Instead, we make a <code>.env.example</code> file, so that anyone who clones our repo knows that these values are needed for our application to run, but won't know the exact sensitive values (like passwords or api keys). It should look like this:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// .env.example</span>
<span class="token constant">PORT</span><span class="token operator">=</span>
<span class="token constant">API_KEY</span><span class="token operator">=</span>
</code></pre></div></div> <h2 id="caching"><a href="#caching" class="header-anchor">#</a> Caching</h2> <h3 id="what-is-a-cache"><a href="#what-is-a-cache" class="header-anchor">#</a> What is a Cache?</h3> <p>In computing, a cache is a high-speed data storage layer which stores a subset of data, typically transient in nature, so that future requests for that data are served up faster than is possible by accessing the data’s primary storage location. Caching allows you to efficiently reuse previously retrieved or computed data.</p> <h3 id="basic-in-memory-cache"><a href="#basic-in-memory-cache" class="header-anchor">#</a> Basic in memory Cache</h3> <p>We can use javascript objects to cache our weather data. This way, if multiple users are walking in Ottawa on the same day, we only need to make one request to the Weather API.</p> <p>We'll crate a separate cacheService to handle the cache.</p> <p>This service will have 2 public methods <code>getWeather</code> and <code>setWeather</code>, and a private function <code>encodeKey</code>.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// src/services/cache.js</span>

<span class="token keyword">const</span> <span class="token constant">CACHE</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">encodeKey</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">city<span class="token punctuation">,</span> startTime</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>city<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">|</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>startTime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">getWeather</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">city<span class="token punctuation">,</span> startTime</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token function">encodeKey</span><span class="token punctuation">(</span>city<span class="token punctuation">,</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token constant">CACHE</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">setWeather</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">city<span class="token punctuation">,</span> startTime<span class="token punctuation">,</span> weatherData</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token function">encodeKey</span><span class="token punctuation">(</span>city<span class="token punctuation">,</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token constant">CACHE</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> weatherData<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  getWeather<span class="token punctuation">,</span>
  setWeather<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Next, we will import our cacheService into our weatherService, and we will check our cache before we make any request to the Weather API.
We will call <code>cacheService.get(city, startTime)</code> to see if we have recently requested the same city / date combination.
If we have the data cached, we will return before we need to hit the Weather API.</p> <p>If the city / data combination is not present in our cache, we will hit the api like normal, and add the data to our cache for next time.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// src/services/weather.js</span>

<span class="token comment">// Add the import</span>
<span class="token keyword">const</span> cacheService <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./cache'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">getWeather</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">city<span class="token punctuation">,</span> startTime</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Here we check our cache and return early if found</span>
  <span class="token keyword">const</span> cachedWeatherData <span class="token operator">=</span> cacheService<span class="token punctuation">.</span><span class="token function">getWeather</span><span class="token punctuation">(</span>city<span class="token punctuation">,</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedWeatherData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> cachedWeatherData<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
      <span class="token string">'https://api.weatherapi.com/v1/history.json'</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">params</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token constant">API_KEY</span><span class="token punctuation">,</span>
          <span class="token literal-property property">q</span><span class="token operator">:</span> city<span class="token punctuation">,</span>
          <span class="token literal-property property">dt</span><span class="token operator">:</span> startTime<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> weatherData <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">temperature</span><span class="token operator">:</span> data<span class="token punctuation">.</span>forecast<span class="token punctuation">.</span>forecastday<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>day<span class="token punctuation">.</span>avgtemp_c<span class="token punctuation">,</span>
      <span class="token literal-property property">rain</span><span class="token operator">:</span> data<span class="token punctuation">.</span>forecast<span class="token punctuation">.</span>forecastday<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>day<span class="token punctuation">.</span>totalprecip_mm<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// Here we add the fetched data to our cache for next time</span>
    cacheService<span class="token punctuation">.</span><span class="token function">setWeather</span><span class="token punctuation">(</span>city<span class="token punctuation">,</span> startTime<span class="token punctuation">,</span> weatherData<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> weatherData<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'e'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token punctuation">.</span>response<span class="token punctuation">.</span>status<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">|</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token punctuation">.</span>response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>error<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Our cache is working, however, every time our server restarts, the cache is lost. If we want it to persist, we will have to use some type of data storage to store the cache between loads.</p> <h2 id="redis"><a href="#redis" class="header-anchor">#</a> Redis</h2> <p>Redis is an open source (BSD licensed), in-memory data structure store used as a database, cache, message broker, and streaming engine.</p> <h3 id="installing-redis-on-your-system"><a href="#installing-redis-on-your-system" class="header-anchor">#</a> Installing Redis on your system</h3> <p>Redis can be install on MacOS using Homebrew</p> <div class="language-bash extra-class"><pre class="language-bash"><code>brew <span class="token function">install</span> redis
</code></pre></div><p>We can check if Redis is running with</p> <div class="language-bash extra-class"><pre class="language-bash"><code>brew services info redis
</code></pre></div><p>Once Redis is running, we can test it by running redis-cli</p> <div class="language-bash extra-class"><pre class="language-bash"><code>redis-cli

<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">set</span> some-key some-value
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get some-key
<span class="token string">&quot;some-value&quot;</span>
</code></pre></div><h3 id="installing-redis-in-our-application"><a href="#installing-redis-in-our-application" class="header-anchor">#</a> Installing redis in our application</h3> <p>Now that we have the redis server running on our computer, we use npm to install the redis package to interact with it in our application.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i redis
</code></pre></div><p>Lets update our cacheService to use Redis instead of a javascript object.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// src/services/cache.js</span>

<span class="token comment">// we create the connection with the redis server on start</span>
<span class="token keyword">const</span> redisClient <span class="token operator">=</span> <span class="token keyword">await</span> redis
  <span class="token punctuation">.</span><span class="token function">createClient</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">url</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REDIS_URL</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">encodeKey</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">city<span class="token punctuation">,</span> startTime</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>city<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">|</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>startTime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">getWeather</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">city<span class="token punctuation">,</span> startTime</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token function">encodeKey</span><span class="token punctuation">(</span>city<span class="token punctuation">,</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token keyword">await</span> redisClient<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">setWeather</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">city<span class="token punctuation">,</span> startTime<span class="token punctuation">,</span> weatherData</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token function">encodeKey</span><span class="token punctuation">(</span>city<span class="token punctuation">,</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  redisClient<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>weatherData<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token constant">EX</span><span class="token operator">:</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token comment">// 5 mins</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  getWeather<span class="token punctuation">,</span>
  setWeather<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Set an expiry time</p> <p>To ensure that the cache doesn't get stale (ie, contain bad data),
we will tell redis to expire the cached value after 5 minutes,
so that we will fetch fresh data from the Weather API again.</p></div> <p>Note that our caching functions are now asynchronous, so we will need to update our weatherService.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// src/services/weather.js</span>

<span class="token keyword">const</span> cacheService <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./cache'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">getWeather</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">city<span class="token punctuation">,</span> startTime</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// We now need to await for cacheService.getWeather</span>
  <span class="token keyword">const</span> cachedWeatherData <span class="token operator">=</span> <span class="token keyword">await</span> cacheService<span class="token punctuation">.</span><span class="token function">getWeather</span><span class="token punctuation">(</span>city<span class="token punctuation">,</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedWeatherData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> cachedWeatherData<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
      <span class="token string">'https://api.weatherapi.com/v1/history.json'</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">params</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token constant">API_KEY</span><span class="token punctuation">,</span>
          <span class="token literal-property property">q</span><span class="token operator">:</span> city<span class="token punctuation">,</span>
          <span class="token literal-property property">dt</span><span class="token operator">:</span> startTime<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> weatherData <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">temperature</span><span class="token operator">:</span> data<span class="token punctuation">.</span>forecast<span class="token punctuation">.</span>forecastday<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>day<span class="token punctuation">.</span>avgtemp_c<span class="token punctuation">,</span>
      <span class="token literal-property property">rain</span><span class="token operator">:</span> data<span class="token punctuation">.</span>forecast<span class="token punctuation">.</span>forecastday<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>day<span class="token punctuation">.</span>totalprecip_mm<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// Here we add the fetched data to our cache for next time</span>
    cacheService<span class="token punctuation">.</span><span class="token function">setWeather</span><span class="token punctuation">(</span>city<span class="token punctuation">,</span> startTime<span class="token punctuation">,</span> weatherData<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> weatherData<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'e'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token punctuation">.</span>response<span class="token punctuation">.</span>status<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">|</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token punctuation">.</span>response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>error<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="more-information"><a href="#more-information" class="header-anchor">#</a> More information</h3> <p><a href="https://www.youtube.com/watch?v=5WFyhsnU4Ik" target="_blank" rel="noopener noreferrer">Steve's Dotenv Tutorial<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://www.weatherapi.com/docs/" target="_blank" rel="noopener noreferrer">Weather API Docs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://axios-http.com/docs/api_intro" target="_blank" rel="noopener noreferrer">Axios Docs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://redis.io/docs/get-started/" target="_blank" rel="noopener noreferrer">Redis Docs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">6/18/2024, 10:18:18 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/s2024/modules/week06/" class="prev">
        Week 6: Midterm Project
      </a></span> <span class="next"><a href="/s2024/modules/break-week/">
        Break Week
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/s2024/assets/js/app.40d35fb0.js" defer></script><script src="/s2024/assets/js/2.d13f26af.js" defer></script><script src="/s2024/assets/js/1.f6f71081.js" defer></script><script src="/s2024/assets/js/35.d62ca566.js" defer></script><script src="/s2024/assets/js/32.baab7363.js" defer></script>
  </body>
</html>
