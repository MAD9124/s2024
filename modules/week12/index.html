<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Week 12: Authentication With Passport | MAD9124</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="Full-stack: API Development">
    
    <link rel="preload" href="/s2024/assets/css/0.styles.70738741.css" as="style"><link rel="preload" href="/s2024/assets/js/app.40d35fb0.js" as="script"><link rel="preload" href="/s2024/assets/js/2.d13f26af.js" as="script"><link rel="preload" href="/s2024/assets/js/1.f6f71081.js" as="script"><link rel="preload" href="/s2024/assets/js/13.07dd1a9d.js" as="script"><link rel="preload" href="/s2024/assets/js/32.baab7363.js" as="script"><link rel="prefetch" href="/s2024/assets/js/10.700b6097.js"><link rel="prefetch" href="/s2024/assets/js/11.ed8a0934.js"><link rel="prefetch" href="/s2024/assets/js/12.9b4b523d.js"><link rel="prefetch" href="/s2024/assets/js/14.b96c24af.js"><link rel="prefetch" href="/s2024/assets/js/15.b144383e.js"><link rel="prefetch" href="/s2024/assets/js/16.d16dea2a.js"><link rel="prefetch" href="/s2024/assets/js/17.b4e1a4e8.js"><link rel="prefetch" href="/s2024/assets/js/18.1f2ac466.js"><link rel="prefetch" href="/s2024/assets/js/19.e668708c.js"><link rel="prefetch" href="/s2024/assets/js/20.4f30b3de.js"><link rel="prefetch" href="/s2024/assets/js/21.248f91f3.js"><link rel="prefetch" href="/s2024/assets/js/22.29f49c1a.js"><link rel="prefetch" href="/s2024/assets/js/23.b8ac89c9.js"><link rel="prefetch" href="/s2024/assets/js/24.e2934475.js"><link rel="prefetch" href="/s2024/assets/js/25.fce0b0a1.js"><link rel="prefetch" href="/s2024/assets/js/26.de8d994d.js"><link rel="prefetch" href="/s2024/assets/js/27.c7ef8247.js"><link rel="prefetch" href="/s2024/assets/js/28.75604c91.js"><link rel="prefetch" href="/s2024/assets/js/29.1b506275.js"><link rel="prefetch" href="/s2024/assets/js/3.8c4cc701.js"><link rel="prefetch" href="/s2024/assets/js/30.787c7c10.js"><link rel="prefetch" href="/s2024/assets/js/31.e47a0c3f.js"><link rel="prefetch" href="/s2024/assets/js/33.aa620044.js"><link rel="prefetch" href="/s2024/assets/js/34.81206c0b.js"><link rel="prefetch" href="/s2024/assets/js/35.d62ca566.js"><link rel="prefetch" href="/s2024/assets/js/36.1835e393.js"><link rel="prefetch" href="/s2024/assets/js/37.5098b7b5.js"><link rel="prefetch" href="/s2024/assets/js/38.3ddeba96.js"><link rel="prefetch" href="/s2024/assets/js/39.3f5b8ef9.js"><link rel="prefetch" href="/s2024/assets/js/4.a03d1287.js"><link rel="prefetch" href="/s2024/assets/js/40.b63f2a79.js"><link rel="prefetch" href="/s2024/assets/js/41.5cb461bc.js"><link rel="prefetch" href="/s2024/assets/js/42.fcb0df3f.js"><link rel="prefetch" href="/s2024/assets/js/43.3a92d7d8.js"><link rel="prefetch" href="/s2024/assets/js/44.5c466f1c.js"><link rel="prefetch" href="/s2024/assets/js/45.c7c3dc1a.js"><link rel="prefetch" href="/s2024/assets/js/46.286df3e7.js"><link rel="prefetch" href="/s2024/assets/js/47.8363bb83.js"><link rel="prefetch" href="/s2024/assets/js/48.56c3e93e.js"><link rel="prefetch" href="/s2024/assets/js/49.b0be2d4e.js"><link rel="prefetch" href="/s2024/assets/js/5.ed6c1368.js"><link rel="prefetch" href="/s2024/assets/js/50.b89e2a53.js"><link rel="prefetch" href="/s2024/assets/js/51.7249e197.js"><link rel="prefetch" href="/s2024/assets/js/52.87fc5cdd.js"><link rel="prefetch" href="/s2024/assets/js/53.56f24714.js"><link rel="prefetch" href="/s2024/assets/js/54.fae6ee81.js"><link rel="prefetch" href="/s2024/assets/js/55.b1e6a4dd.js"><link rel="prefetch" href="/s2024/assets/js/56.eadf21bf.js"><link rel="prefetch" href="/s2024/assets/js/57.d912e614.js"><link rel="prefetch" href="/s2024/assets/js/6.45d9b7e6.js"><link rel="prefetch" href="/s2024/assets/js/7.017a2e0d.js"><link rel="prefetch" href="/s2024/assets/js/vendors~docsearch.38838867.js">
    <link rel="stylesheet" href="/s2024/assets/css/0.styles.70738741.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/s2024/" class="home-link router-link-active"><!----> <span class="site-name">MAD9124</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/s2024/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/s2024/modules/" class="nav-link router-link-active">
  Modules
</a></div><div class="nav-item"><a href="/s2024/deliverables/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/s2024/resources/" class="nav-link">
  Resources
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/s2024/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/s2024/modules/" class="nav-link router-link-active">
  Modules
</a></div><div class="nav-item"><a href="/s2024/deliverables/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/s2024/resources/" class="nav-link">
  Resources
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Introduction</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Content Modules</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/s2024/modules/" aria-current="page" class="sidebar-link">Table of contents</a></li><li><a href="/s2024/modules/week01/" class="sidebar-link">Week 1: Introduction &amp; Review</a></li><li><a href="/s2024/modules/week02/" class="sidebar-link">Week 2: Node Modules &amp; Express</a></li><li><a href="/s2024/modules/week03/" class="sidebar-link">Week 3: APIs</a></li><li><a href="/s2024/modules/week04/" class="sidebar-link">Week 4: Project Structure, RESTful alternatives, and Postman</a></li><li><a href="/s2024/modules/week05/" class="sidebar-link">Week 5: Middleware</a></li><li><a href="/s2024/modules/week06/" class="sidebar-link">Week 6: Midterm Project</a></li><li><a href="/s2024/modules/week07/" class="sidebar-link">Week 7: API Integration &amp; Caching</a></li><li><a href="/s2024/modules/break-week/" class="sidebar-link">Break Week</a></li><li><a href="/s2024/modules/week09/" class="sidebar-link">Week 9: Data Persitance and MongoDB</a></li><li><a href="/s2024/modules/week10/" class="sidebar-link">Week 10: Object Data Modelling with Mongoose</a></li><li><a href="/s2024/modules/week11/" class="sidebar-link">Week 11: Data Santization, XSS and LoggingS</a></li><li><a href="/s2024/modules/week12/" aria-current="page" class="active sidebar-link">Week 12: Authentication With Passport</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/s2024/modules/week12/#agenda" class="sidebar-link">Agenda</a></li><li class="sidebar-sub-header"><a href="/s2024/modules/week12/#ama-review" class="sidebar-link">AMA / Review</a></li><li class="sidebar-sub-header"><a href="/s2024/modules/week12/#what-is-passport" class="sidebar-link">What is Passport?</a></li><li class="sidebar-sub-header"><a href="/s2024/modules/week12/#create-a-google-application" class="sidebar-link">Create a Google Application</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/s2024/modules/week12/#creating-your-google-account" class="sidebar-link">Creating your Google Account</a></li><li class="sidebar-sub-header"><a href="/s2024/modules/week12/#creating-your-first-project" class="sidebar-link">Creating your first project</a></li><li class="sidebar-sub-header"><a href="/s2024/modules/week12/#setting-up-the-oauth-consent-screen" class="sidebar-link">Setting up the OAuth Consent Screen</a></li><li class="sidebar-sub-header"><a href="/s2024/modules/week12/#creating-our-shared-credentials" class="sidebar-link">Creating our shared credentials</a></li><li class="sidebar-sub-header"><a href="/s2024/modules/week12/#we-are-all-set-with-google" class="sidebar-link">We are all set with Google!</a></li></ul></li><li class="sidebar-sub-header"><a href="/s2024/modules/week12/#setting-up-passport-application" class="sidebar-link">Setting up Passport Application</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/s2024/modules/week12/#install-the-dependencies" class="sidebar-link">Install the dependencies</a></li><li class="sidebar-sub-header"><a href="/s2024/modules/week12/#set-up-our-index-js-file" class="sidebar-link">Set up our index.js file</a></li><li class="sidebar-sub-header"><a href="/s2024/modules/week12/#create-the-user-model" class="sidebar-link">Create the User Model</a></li><li class="sidebar-sub-header"><a href="/s2024/modules/week12/#configure-the-strategy" class="sidebar-link">Configure the strategy</a></li></ul></li><li class="sidebar-sub-header"><a href="/s2024/modules/week12/#json-web-token" class="sidebar-link">JSON Web Token</a></li><li class="sidebar-sub-header"><a href="/s2024/modules/week12/#generating-the-token" class="sidebar-link">Generating the token</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/s2024/modules/week12/#better-redirects-using-state" class="sidebar-link">Better redirects using state</a></li></ul></li><li class="sidebar-sub-header"><a href="/s2024/modules/week12/#authenticating-with-jwt" class="sidebar-link">Authenticating with JWT</a></li><li class="sidebar-sub-header"><a href="/s2024/modules/week12/#using-req-user-to-own-a-resource" class="sidebar-link">Using req.user to own a resource</a></li></ul></li><li><a href="/s2024/modules/week13/" class="sidebar-link">Week 13: Testing with Jest</a></li><li><a href="/s2024/modules/week14/" class="sidebar-link">Week 14: Preparing for Production</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1><span class="week">Week 12</span><br> <span class="title">Authentication With Passport</span></h1> <h2 id="agenda"><a href="#agenda" class="header-anchor">#</a> Agenda</h2> <ul><li>AMA (10 mins)</li> <li>What is Passport</li> <li>Create a Google Application</li> <li>Setting up Passport Application</li> <li>Sessions</li> <li>Locking Down Routes</li> <li>Persisting our Session</li> <li>Testing in Postman</li></ul> <h2 id="ama-review"><a href="#ama-review" class="header-anchor">#</a> AMA / Review</h2> <h2 id="what-is-passport"><a href="#what-is-passport" class="header-anchor">#</a> What is Passport?</h2> <p>Passport is authentication middleware for Node.js. Extremely flexible and modular, Passport can be unobtrusively dropped in to any Express-based web application. A comprehensive set of strategies support authentication using a username and password, Google, Facebook, Twitter, and more. Check out their website <a href="https://www.passportjs.org/" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. We will be using <a href="https://www.passportjs.org/packages/passport-google-oauth20/" target="_blank" rel="noopener noreferrer">passport-google-oauth2.0<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="create-a-google-application"><a href="#create-a-google-application" class="header-anchor">#</a> Create a Google Application</h2> <h3 id="creating-your-google-account"><a href="#creating-your-google-account" class="header-anchor">#</a> Creating your Google Account</h3> <p>Before we can use passport to login via Google, we will need to create a Google application, and generate keys that we will share with Google, so they know who we are.</p> <p>Begin the process by going to <a href="https://console.developers.google.com/" target="_blank" rel="noopener noreferrer">Google Developers Console<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, and creating a google account with your algonquincollege email.
<img src="/s2024/assets/img/google_sign_in.5c9053a6.png" alt="Sign In"></p> <p>You will need to provide your phone number for 2FA, as well as a few other details.</p> <p><img src="/s2024/assets/img/google_sign_up.28d49f6c.png" alt="Sign Up"></p> <p>Once you are signed up and signed in, you should be able to get to this <a href="https://console.cloud.google.com/projectselector2/apis/dashboard" target="_blank" rel="noopener noreferrer">page<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>:</p> <p><img src="/s2024/assets/img/APIs_and_services.0b20fa07.png" alt="API page"></p> <hr> <h3 id="creating-your-first-project"><a href="#creating-your-first-project" class="header-anchor">#</a> Creating your first project</h3> <p>Now we need to create a project.</p> <ul><li>click on the <code>Select a project</code> dropdown at the top left of the page.
<img src="/s2024/assets/img/create_project.1e3e6212.png" alt="Create project"></li> <li>name your project using your student number and week12
<img src="/s2024/assets/img/create_project_form.498aa5c9.png" alt="Create project form"></li></ul> <h3 id="setting-up-the-oauth-consent-screen"><a href="#setting-up-the-oauth-consent-screen" class="header-anchor">#</a> Setting up the OAuth Consent Screen</h3> <ul><li>Navigate to APIs &amp; Services / Oauth consent screen</li> <li>Select User Type External and click CREATE
<img src="/s2024/assets/img/google_oauth_consent01.d7f513e8.png" alt="Oauth Consent Screen"></li> <li>Fill out the form with App name, User support email (your algonquin email), and Developer contact email (also you algonquin email)</li></ul> <p><em>The rest of the information can be skipped for now, but should be filled out in a non testing environment</em></p> <ul><li>Add the scope <code>./auth/userinfo.profile</code>, we will get the user's name and email from google.</li></ul> <p><em>We will not be needing any sensitive scopes for this project</em></p> <ul><li>Add test users. Only users on the list will be able to sign in to your app. Please add yourself and me <code>robillt@algonquincollege.com</code> so I can sign in to your app!
<img src="/s2024/assets/img/google_oauth_add_user.cd37d846.png" alt="Oauth Consent Screen Users"></li> <li>Fill out the form with App name, User support email (your algonquin email), and Developer contact email (also you algonquin email)</li> <li>Review all of your entries, and hit back to dashboard if it is all good.</li></ul> <h3 id="creating-our-shared-credentials"><a href="#creating-our-shared-credentials" class="header-anchor">#</a> Creating our shared credentials</h3> <p>Google will need a way to connect requests coming from our node application to the application we are setting up in Google. We can do this using generated credentials.</p> <p><img src="/s2024/assets/img/google_credentials01.70df21e3.png" alt="Google Credntials dashboard"></p> <ul><li>Navigate to APIs &amp; Services / Credentials</li> <li>Click Create Credentials, OAuth client ID</li> <li>Fill out the form with Application type: <code>Web application</code>, name whatever you like, and add <code>http://localhost:3000</code> as the authorized JavaScript origin, and <code>http://localhost:4000/auth/google/callback</code> as the Authorized redirect URI</li></ul> <p><em>NOTE - You will have to tell google your production domains when you are ready to deploy. ex <code>https://example.ca</code></em></p> <ul><li>Once it is done you should see the following modal. Copy the client ID and Client Secret, and add it to your .env file
<img src="/s2024/assets/img/google_credentials_success.677594d6.png" alt="Google Success"> <img src="data:image/png;base64,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" alt="env"></li></ul> <p><em>It is important to keep these safe. DO NOT COMMIT THEM TO GITHUB.
I have deleted the credentials in the picture</em></p> <h3 id="we-are-all-set-with-google"><a href="#we-are-all-set-with-google" class="header-anchor">#</a> We are all set with Google!</h3> <hr> <h2 id="setting-up-passport-application"><a href="#setting-up-passport-application" class="header-anchor">#</a> Setting up Passport Application</h2> <h3 id="install-the-dependencies"><a href="#install-the-dependencies" class="header-anchor">#</a> Install the dependencies</h3> <p>We will need to install our usual depencies, plus 3 new dependencies:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">yarn</span> <span class="token function">add</span> express mongoose morgan passport passport-google-oauth2 express-session
</code></pre></div><p><em>NOTE more on express-session later</em></p> <h3 id="set-up-our-index-js-file"><a href="#set-up-our-index-js-file" class="header-anchor">#</a> Set up our index.js file</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;dotenv/config&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> morgan <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;morgan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">morgan</span><span class="token punctuation">(</span><span class="token string">&quot;tiny&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">_req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Hello, world!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">PORT</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">4000</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Server listening on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="create-the-user-model"><a href="#create-the-user-model" class="header-anchor">#</a> Create the User Model</h3> <p>In <code>src/models/User.js</code>, define the User schema and model. We will be getting the name and googleId from google.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> model<span class="token punctuation">,</span> Schema <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;mongoose&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> UserSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> String<span class="token punctuation">,</span>
      <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">googleId</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> String<span class="token punctuation">,</span>
      <span class="token literal-property property">unique</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">timestamps</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> UserSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="configure-the-strategy"><a href="#configure-the-strategy" class="header-anchor">#</a> Configure the strategy</h3> <p>We will configure passport in its own file to keep it neat.</p> <p>Begin by importing the required libraries and User Model</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// util/passport.js</span>
<span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> GoogleStrategy <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;passport-google-oauth20&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> passport <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;passport&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> User <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../models/User&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">GOOGLE_CLIENT_ID</span><span class="token punctuation">,</span> <span class="token constant">GOOGLE_CLIENT_SECRET</span><span class="token punctuation">,</span> <span class="token constant">GOOGLE_CALLBACK_URL</span> <span class="token punctuation">}</span> <span class="token operator">=</span>
  process<span class="token punctuation">.</span>env<span class="token punctuation">;</span>
</code></pre></div><p>Next, we tell passport to use the the GoogleStrategy, and configure it with our ids and urls.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>passport<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">GoogleStrategy</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span>
      <span class="token comment">// Dont forget to import from process.env</span>
      <span class="token literal-property property">clientID</span><span class="token operator">:</span> <span class="token constant">GOOGLE_CLIENT_ID</span><span class="token punctuation">,</span>
      <span class="token literal-property property">clientSecret</span><span class="token operator">:</span> <span class="token constant">GOOGLE_CLIENT_SECRET</span><span class="token punctuation">,</span>
      <span class="token literal-property property">callbackURL</span><span class="token operator">:</span> <span class="token constant">GOOGLE_CALLBACK_URL</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">_accessToken<span class="token punctuation">,</span> _refreshToken<span class="token punctuation">,</span> profile<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// here, we will look up a user by the googleId, and either</span>
        <span class="token comment">// create a new User if none exists, or</span>
        <span class="token comment">// update the existing User, in case they changed their name in google.</span>
        <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOneAndUpdate</span><span class="token punctuation">(</span>
          <span class="token punctuation">{</span> <span class="token literal-property property">googleId</span><span class="token operator">:</span> profile<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token literal-property property">$set</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token literal-property property">name</span><span class="token operator">:</span> profile<span class="token punctuation">.</span>displayName<span class="token punctuation">,</span>
              <span class="token literal-property property">googleId</span><span class="token operator">:</span> profile<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token comment">// upsert is how we tell mongoose to UP-date the document or in-SERT a new one</span>
          <span class="token comment">// don't forget to tell mongoose to return the updated document!</span>
          <span class="token punctuation">{</span> <span class="token literal-property property">upsert</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">cb</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Next we will create our authentication routes. One will be the route to redirect to google, asking to login. The next is the route google will send its response to with either a success or an error depending on what happens with google.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// router/auth.js</span>
<span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> Router <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> passport <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;passport&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> authRouter <span class="token operator">=</span> <span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// make sure to import the configuration we set up above</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../util/passport&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// this route will redirect the user to google</span>
authRouter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
  <span class="token string">&quot;/google&quot;</span><span class="token punctuation">,</span>
  passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">&quot;google&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">scope</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;profile&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// this route will be hit by google once they are finished.</span>
authRouter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
  <span class="token string">&quot;/google/callback&quot;</span><span class="token punctuation">,</span>
  passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">&quot;google&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">failureRedirect</span><span class="token operator">:</span> <span class="token string">&quot;/fail&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">session</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">_req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/success&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> authRouter<span class="token punctuation">;</span>
</code></pre></div><p>We will temporarily add these <code>/success</code> and <code>/fail</code> routes so we can test that it works.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// index.js</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/success&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">_req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/fail&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">_req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Fail&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="test-in-you-browser"><a href="#test-in-you-browser" class="header-anchor">#</a> Test in you browser</h4> <p>In your browser, go to <code>http://localhost:4000/auth/google</code>. You should be redirected to Google's OAuth consent page. After choosing the correct account, and accept all the criteria, you should be redirected back to your api at <code>http://localhost:4000/auth/google/callback</code>, and finally, if you were authenticated correctly by Google, to the <code>/success</code> route, and Success should be printed on the page!</p> <div class="custom-block tip"><p class="custom-block-title">Note</p> <p>You will not notice the redirect to /auth/google/callback. It should be too fast to notice, and feel like you were sent straight to /success</p></div> <p>We have successfully authenticated, Hoorray!!</p> <p>Making our users perform this login flow every time is a bad user experience. We will next create a signed token, give it to the user, and allow any further requests containing the token to automatically be authenticated.</p> <h2 id="json-web-token"><a href="#json-web-token" class="header-anchor">#</a> JSON Web Token</h2> <p>Now that we have been authenticated by Google, we will use the industry standard <a href="https://jwt.io/introduction/" target="_blank" rel="noopener noreferrer">JSON Web Tokens (JWT)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to persist our user session. There are libraries for just about every popular programming language. Let's install the Node.js module.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">yarn</span> <span class="token function">add</span> jsonwebtoken
</code></pre></div><p>We will use this library to store our user id in a <code>JWT</code> token, and pass the JWT to the client, to be saved in <code>localstorage</code> or <code>sessionstorage</code></p> <p>You should read the full documentation on JWTs but here are two critical things to understand.</p> <ol><li><p>The payload is Base64Url encode, <strong>not encrypted or hashed</strong>. Anyone with some JavaScript can read it. So, never put sensitive data in the token payload.</p></li> <li><p>The token is cryptographically signed using a secret key on your sever. So we can validate that no one has altered the contents of the payload. Which means we can trust it.</p></li></ol> <p>Let's <a href="https://www.npmjs.com/package/jsonwebtoken" target="_blank" rel="noopener noreferrer">check the usage instructions<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ...</p> <p>We need to require the library at the top.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// src/router/auth.js</span>

<span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;jsonwebtoken&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>We will get the secret from our <code>.env</code> file.</p> <div class="language- extra-class"><pre class="language-text"><code>JWT_SECRET=super-secret-password
</code></pre></div><h2 id="generating-the-token"><a href="#generating-the-token" class="header-anchor">#</a> Generating the token</h2> <p>We only want to save the user's id in our JWT token, so that we can use the id to lookup the user's data. This prevents holding stale data in the token in the event the user document is updated.</p> <p>After a successful return from google, passport will automatically add the user to the request, so we can access the user's <code>_id</code> from here.</p> <p>Use the jsonwebtoken library and the secret from <code>process.env</code> to sign a new token, and send it with the redirectUrl to the client.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// src/router/auth.js</span>

authRouter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
  <span class="token string">&quot;/google/callback&quot;</span><span class="token punctuation">,</span>
  passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">&quot;google&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">failureRedirect</span><span class="token operator">:</span> <span class="token string">&quot;/fail&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> token <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>_id <span class="token punctuation">}</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">JWT_SECRET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/success?token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Test again in the browser.</p> <h3 id="better-redirects-using-state"><a href="#better-redirects-using-state" class="header-anchor">#</a> Better redirects using state</h3> <p>Instead of hard coding a redirect to a route on our server, we can instead accept a <code>redirec_url</code> from the client, with a url that they want us to redirect to after a successful authentication. This url will usually contain logic to save the token locally.</p> <p>Google Oauth allows us to pass a string as state to the initial redirect, and it will add the same value to the redirect it sends back to us at <code>/auth/google/callback</code>. We will use this to keep track of the redirect_url from our client. We will need to tweak our 2 auth routes.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>authRouter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/google&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> redirect_url <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>

  <span class="token comment">// we will encode our url in a json object, similar to a json token (not signed!)</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> redirect_url
    <span class="token operator">?</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> redirect_url <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">&quot;base64&quot;</span><span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

  <span class="token comment">// we can pass `req`, `res`, and `next` into the middleware function like this,</span>
  <span class="token comment">// allowing us to pass extra data from the request</span>
  <span class="token keyword">return</span> passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">&quot;google&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">scope</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;profile&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    state<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

authRouter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
  <span class="token string">&quot;/google/callback&quot;</span><span class="token punctuation">,</span>
  passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">&quot;google&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">failureRedirect</span><span class="token operator">:</span> <span class="token string">&quot;/fail&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">session</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> state <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>

    <span class="token comment">// decode the state property if it exists</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> redirect_url <span class="token punctuation">}</span> <span class="token operator">=</span> state
      <span class="token operator">?</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token string">&quot;base64&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token function">generateToken</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// default to /success if no redirect_url was found</span>
    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>redirect_url <span class="token operator">??</span> <span class="token string">&quot;/success&quot;</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>We can test this out in our browser by going to <code>http://localhost:4000/auth/google?redirect_url=http://localhost:3000/login/success</code>. Nothing is running at this port, so we will see the <code>This site can't be reached</code> page, but looking at the url, we should see our token passed along to the client!</p> <h2 id="authenticating-with-jwt"><a href="#authenticating-with-jwt" class="header-anchor">#</a> Authenticating with JWT</h2> <p>Now that the token has been generated, we will expect the client to store this token, and any requests that will come from the authenticated user will include this token in the headers.</p> <p>We can use another Passport Strategy, the <a href="https://www.passportjs.org/packages/passport-http-bearer/" target="_blank" rel="noopener noreferrer">Bearer Strategy<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to access the token stored in an industry standard way: in the Authorization header, with the format <code>Bearer [token]</code></p> <p>First, we will register our new strategy in util/passport.js.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>passport<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  <span class="token comment">// the strategy gets the token for us from the headers.</span>
  <span class="token keyword">new</span> <span class="token class-name">BearerStrategy</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">token<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// we decoded the token using the verify method. This will throw an error if the signature cannot be verified</span>
      <span class="token keyword">const</span> decodedToken <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">JWT_SECRET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// next, we use the id from our token to lookup the user in Mongoose</span>
      <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>decodedToken<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// finally, we either throw an error, or pass on the user to passports callback function</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnauthenticatedError</span><span class="token punctuation">(</span><span class="token string">&quot;Unauthorized&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UnauthenticatedError</span><span class="token punctuation">(</span><span class="token string">&quot;Unauthorized&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Passing the user to the <code>done</code> function will automatically attach the user to the request at <code>req.user</code>.</p> <p>Passport uses its own errors, and we want to throw our custom <code>UnauthenticatedError</code> when a user is unauthenticated. We will create our own middleware function that will piggy back off the default <code>passport.authenticate</code> middleware function to instead throw one of our own errors.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">isAuthenticated</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">&quot;bearer&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">session</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token literal-property property">failWithError</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UnauthenticatedError</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>We'll create a <code>/private</code> route that uses our isAuthenticated middleware function, and see what happens when we make a request with or without a token!</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// index.js</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/private&quot;</span><span class="token punctuation">,</span> isAuthenticated<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">&quot;You are in!&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">user</span><span class="token operator">:</span> req<span class="token punctuation">.</span>user<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Without a token stored in the request headers, we will get a 401 <code>unauthorized</code> error.</p> <p><img src="/s2024/assets/img/no_token.edd714e7.png" alt="no token"></p> <p>With a token, we can see we are authenticated, and our user document is attached to the request!</p> <p><img src="/s2024/assets/img/with_token.22433cf1.png" alt="with token"></p> <h2 id="using-req-user-to-own-a-resource"><a href="#using-req-user-to-own-a-resource" class="header-anchor">#</a> Using <code>req.user</code> to own a resource</h2> <p>Currently, our car application allows us to apply crud operations to any car in the platform. This may be how the application is intended to behave, but a more likely scenario is I won't want another user updating or deleting my cars. We can add an <code>owner</code> property to our car schema, referencing the user collection. And use this combined with the <code>req.uesr.id</code> value to ensure only the owner of the car is able to update or delete their cars.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> carSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">make</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token literal-property property">minLength</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token literal-property property">maxLength</span><span class="token operator">:</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">model</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token literal-property property">minLength</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token literal-property property">maxLength</span><span class="token operator">:</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">colour</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token literal-property property">minLength</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token literal-property property">maxLength</span><span class="token operator">:</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">seats</span><span class="token operator">:</span> <span class="token punctuation">[</span>String<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">details</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">battery</span><span class="token operator">:</span> Number<span class="token punctuation">,</span>
      <span class="token literal-property property">kilometers</span><span class="token operator">:</span> Number<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">owner</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> mongoose<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span>
      <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">ref</span><span class="token operator">:</span> <span class="token string">&quot;User&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">timestamps</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>First, let's lock down our car router, so only authenticated users can interact with our car resource.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// routers/cars.js</span>

<span class="token comment">// ... other imports</span>
<span class="token keyword">const</span> isAuthenticated <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../middlewares/isAuthenticated&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> carRouter <span class="token operator">=</span> <span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
carRouter<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>isAuthenticated<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ... rest of routes</span>
</code></pre></div><p>Locking down the carRouter adds a layer of security to our application, and gives us the added benefit of knowing which user is making each request, via <code>req.user</code>.</p> <p>We can use this information to update how we create our cars. In the controller, we can get the user's <code>_id</code> value from <code>req.user._id</code> as the <code>owner</code> property on the new car.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// controllers/cars.js</span>

<span class="token keyword">const</span> <span class="token function-variable function">create</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ownerId <span class="token operator">=</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>_id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> newCar <span class="token operator">=</span> <span class="token keyword">await</span> carService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token operator">...</span>req<span class="token punctuation">.</span>sanitizedBody<span class="token punctuation">,</span>
      <span class="token literal-property property">owner</span><span class="token operator">:</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>_id<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> newCar<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Test with postman</p> <p><img src="/s2024/assets/img/create_car.88215537.png" alt="created car"></p> <p>Next, we can pass the <code>req.user._id</code> to our carService <code>update</code> and <code>deleteOne</code> functions, and throw an <code>FORBIDDEN</code> error if the wrong user tries to update or delete a car!</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// controllers/cars.js</span>

<span class="token keyword">const</span> <span class="token function-variable function">update</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    <span class="token keyword">const</span> ownerId <span class="token operator">=</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>_id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> updatedCar <span class="token operator">=</span> <span class="token keyword">await</span> carService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> ownerId<span class="token punctuation">,</span> req<span class="token punctuation">.</span>sanitizedBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> updatedCar<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">deleteOne</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    <span class="token keyword">const</span> ownerId <span class="token operator">=</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>_id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> deletedCar <span class="token operator">=</span> <span class="token keyword">await</span> carService<span class="token punctuation">.</span><span class="token function">deleteOne</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> ownerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> deletedCar <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// services/cars.js</span>

<span class="token keyword">const</span> <span class="token function-variable function">update</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> ownerId<span class="token punctuation">,</span> updates</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> foundCar <span class="token operator">=</span> <span class="token keyword">await</span> Car<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>foundCar<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Car with id </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>foundCar<span class="token punctuation">.</span>owner<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!==</span> ownerId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ForbiddenError</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">You do not have permission to perform this action</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> updatedCar <span class="token operator">=</span> <span class="token keyword">await</span> Car<span class="token punctuation">.</span><span class="token function">findByIdAndUpdate</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> updates<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">new</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> updatedCar<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">deleteOne</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> ownerId</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> foundCar <span class="token operator">=</span> <span class="token keyword">await</span> Car<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>foundCar<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Car with id </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>foundCar<span class="token punctuation">.</span>owner<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!==</span> ownerId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ForbiddenError</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">You do not have permission to perform this action</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> deletedCar <span class="token operator">=</span> <span class="token keyword">await</span> Car<span class="token punctuation">.</span><span class="token function">findByIdAndDelete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> deletedCar<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Be careful of stale data</p> <p>If you are working with old car data, without an owner property, you may encounter an error:
<code>TypeError: Cannot read properties of undefined (reading 'toString')</code>
Make sure to clean up your old data!</p></div> <div class="custom-block warning"><p class="custom-block-title">Assignment Reminder</p> <p><a href="/s2024/deliverables/assignment3.html">Assignment 3 - Authentication</a> - is due <strong>before</strong> next week's class.</p></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/8/2024, 12:21:55 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/s2024/modules/week11/" class="prev">
        Week 11: Data Santization, XSS and LoggingS
      </a></span> <span class="next"><a href="/s2024/modules/week13/">
        Week 13: Testing with Jest
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/s2024/assets/js/app.40d35fb0.js" defer></script><script src="/s2024/assets/js/2.d13f26af.js" defer></script><script src="/s2024/assets/js/1.f6f71081.js" defer></script><script src="/s2024/assets/js/13.07dd1a9d.js" defer></script><script src="/s2024/assets/js/32.baab7363.js" defer></script>
  </body>
</html>
