(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{388:function(t,a,s){t.exports=s.p+"assets/img/google_storage01.d9a76a00.png"},389:function(t,a,s){t.exports=s.p+"assets/img/google_storage02.342d531b.png"},390:function(t,a,s){t.exports=s.p+"assets/img/google_storage_create01.abf21d73.png"},391:function(t,a,s){t.exports=s.p+"assets/img/google_storage_create02.f4a10b44.png"},392:function(t,a,s){t.exports=s.p+"assets/img/google_storage_create03.b1e300d6.png"},393:function(t,a,s){t.exports=s.p+"assets/img/google_storage_create04.3459c171.png"},394:function(t,a,s){t.exports=s.p+"assets/img/google_storage_create05.b88c44aa.png"},395:function(t,a,s){t.exports=s.p+"assets/img/google_storage_permissions02.79ad8d10.png"},396:function(t,a,s){t.exports=s.p+"assets/img/google_service_account.d2288e98.png"},397:function(t,a,s){t.exports=s.p+"assets/img/google_service_account_key.635fb49c.png"},398:function(t,a,s){t.exports=s.p+"assets/img/google_bucket_permissions01.47c4e8e1.png"},399:function(t,a,s){t.exports=s.p+"assets/img/postman_test.3501e873.png"},455:function(t,a,s){"use strict";s.r(a);var e=s(14),n=Object(e.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("WeekHeader",{attrs:{number:14,title:"Preparing for Production"}}),t._v(" "),a("h2",{attrs:{id:"agenda"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#agenda"}},[t._v("#")]),t._v(" Agenda")]),t._v(" "),a("ul",[a("li",[t._v("AMA (10 mins)")]),t._v(" "),a("li",[t._v("File storage with Google Cloud Storage")])]),t._v(" "),a("hr"),t._v(" "),a("h2",{attrs:{id:"storing-files-with-google-cloud-storage"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#storing-files-with-google-cloud-storage"}},[t._v("#")]),t._v(" Storing files with Google Cloud Storage")]),t._v(" "),a("p",[t._v("Let's say we want to allow our users to store images of their cars. We will need a way to store images and or other files for our application. We could store them locally, but that could lead to disk space issues, and other optimization issues.")]),t._v(" "),a("p",[t._v("Luckily, there are many services out there that can store files for us, "),a("strong",[t._v("and")]),t._v(" distribute those files across the globe in an efficient way. Some popular options include "),a("a",{attrs:{href:"https://www.filestack.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Filestack"),a("OutboundLink")],1),t._v(", "),a("a",{attrs:{href:"https://aws.amazon.com/s3/",target:"_blank",rel:"noopener noreferrer"}},[t._v("AWS S3"),a("OutboundLink")],1),t._v(" and "),a("a",{attrs:{href:"https://cloud.google.com/storage?hl=en",target:"_blank",rel:"noopener noreferrer"}},[t._v("Google Cloud Storage"),a("OutboundLink")],1),t._v(".")]),t._v(" "),a("p",[t._v("Since we all ready are set up with Google Cloud, let's use Google Cloud Storage to manage our image storage.")]),t._v(" "),a("h3",{attrs:{id:"google-cloud-free-trial"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#google-cloud-free-trial"}},[t._v("#")]),t._v(" Google Cloud Free Trial")]),t._v(" "),a("p",[t._v("Google Cloud Storage is behind a pay wall unfortunately, so wE will need to provide a credit card number. However, they have a generous "),a("a",{attrs:{href:"https://cloud.google.com/free",target:"_blank",rel:"noopener noreferrer"}},[t._v("Free Tier"),a("OutboundLink")],1),t._v(", which includes 5GB a month in Standard Storage. Plus, they have a free trial period, where they give you $300 to try there services for free!")]),t._v(" "),a("p",[t._v("Navigate to "),a("a",{attrs:{href:"https://cloud.google.com/storage?hl=en",target:"_blank",rel:"noopener noreferrer"}},[t._v("Google Cloud Storage"),a("OutboundLink")],1),t._v(", and click on "),a("strong",[t._v("Try Free Storage")]),t._v(". This will take you to the free trial sign up flow. Follow this through to sign up for the free trial.")]),t._v(" "),a("p",[a("img",{attrs:{src:s(388),alt:"google storage start page"}})]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),a("p",[t._v("If you are nervous about Google having your Credit Card, set a remind to cancel the trial before it runs out.\nOther options include setting a credit limit, or adding an alert when your monthly charge gets to a threshold.\nInfo can be found "),a("a",{attrs:{href:"https://support.google.com/paymentscenter/answer/9034387?hl=en",target:"_blank",rel:"noopener noreferrer"}},[t._v("here"),a("OutboundLink")],1)])]),t._v(" "),a("h3",{attrs:{id:"creating-the-bucket"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#creating-the-bucket"}},[t._v("#")]),t._v(" Creating the Bucket")]),t._v(" "),a("p",[t._v("Now that we are set up, navigate to the "),a("a",{attrs:{href:"https://console.cloud.google.com/storage/browser",target:"_blank",rel:"noopener noreferrer"}},[t._v("Cloud Storage Buckets page"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("img",{attrs:{src:s(389),alt:"google storage buck page"}})]),t._v(" "),a("p",[t._v("Click on "),a("strong",[t._v("Create")]),t._v(" at the top, and we will begin setting up our "),a("code",[t._v("Bucket")]),t._v(". (This is google's term for a group of stored files. We store things in different buckets). We will create a bucket for our cars project.")]),t._v(" "),a("p",[t._v("Follow the flow to:")]),t._v(" "),a("h4",{attrs:{id:"name-your-bucket"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#name-your-bucket"}},[t._v("#")]),t._v(" Name your bucket")]),t._v(" "),a("p",[a("img",{attrs:{src:s(390),alt:"name cloud bucket"}})]),t._v(" "),a("h4",{attrs:{id:"store-your-data-default"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#store-your-data-default"}},[t._v("#")]),t._v(" Store your data (default)")]),t._v(" "),a("p",[a("img",{attrs:{src:s(391),alt:"store cloud bucket location"}})]),t._v(" "),a("h4",{attrs:{id:"choose-the-storage-class-default"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#choose-the-storage-class-default"}},[t._v("#")]),t._v(" Choose the storage class (default)")]),t._v(" "),a("p",[a("img",{attrs:{src:s(392),alt:"storage type cloud bucket"}})]),t._v(" "),a("h4",{attrs:{id:"choose-how-the-files-can-be-accessed-we-want-all-of-our-images-to-be-publicly-accessible-so-we-choose-uniform-access-control-and-we-will-not-enforce-public-access-prevention-on-the-bucket"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#choose-how-the-files-can-be-accessed-we-want-all-of-our-images-to-be-publicly-accessible-so-we-choose-uniform-access-control-and-we-will-not-enforce-public-access-prevention-on-the-bucket"}},[t._v("#")]),t._v(" Choose how the files can be accessed. We want all of our images to be publicly accessible, so we choose "),a("strong",[t._v("Uniform")]),t._v(" Access control, and we will "),a("strong",[t._v("Not")]),t._v(" enforce public access prevention on the bucket")]),t._v(" "),a("p",[a("img",{attrs:{src:s(393),alt:"access cloud bucket"}})]),t._v(" "),a("h4",{attrs:{id:"and-finally-choose-how-to-protect-deleted-objects-default"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#and-finally-choose-how-to-protect-deleted-objects-default"}},[t._v("#")]),t._v(" And finally, choose how to protect deleted objects (default)")]),t._v(" "),a("p",[a("img",{attrs:{src:s(394),alt:"name cloud buck"}})]),t._v(" "),a("p",[t._v("Click on "),a("strong",[t._v("Create")]),t._v(" to create your Bucket!")]),t._v(" "),a("h3",{attrs:{id:"allowing-public-access"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#allowing-public-access"}},[t._v("#")]),t._v(" Allowing Public Access")]),t._v(" "),a("p",[t._v("When creating our Bucket, we chose "),a("strong",[t._v("Uniform")]),t._v(" Access to all of the files in our Bucket. By default, our files are not public. We need to change this in order for our users to be able to see the images after they are uploaded.")]),t._v(" "),a("p",[t._v("With you bucket selected, click on the "),a("strong",[t._v("Permissions")]),t._v(" tab. Click on "),a("strong",[t._v("GRANT ACCESS")]),t._v(" to open up the Grant Access drawer.")]),t._v(" "),a("p",[a("img",{attrs:{src:s(395),alt:"permissions drawer"}})]),t._v(" "),a("p",[t._v("Add principal "),a("code",[t._v("allUsers")]),t._v(", and assign the Role "),a("code",[t._v("Storage Object Viewer")]),t._v(". This tells google that All Users can view the Objects stored in this Bucket.")]),t._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[t._v("Are you sure that you want to make this resource public?")]),t._v(" "),a("p",[t._v("Yes, we are sure!")]),t._v(" "),a("p",[t._v("Google will give us warnings that our files are publicly accessible, but that is how we want them to be.")])]),t._v(" "),a("h3",{attrs:{id:"connecting-to-our-application"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#connecting-to-our-application"}},[t._v("#")]),t._v(" Connecting to our Application")]),t._v(" "),a("h4",{attrs:{id:"creating-a-service-account"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#creating-a-service-account"}},[t._v("#")]),t._v(" Creating a Service Account")]),t._v(" "),a("p",[t._v("Now that our Bucket is set up, we now will need to connect it to our app, so we can send files we want to be saved.")]),t._v(" "),a("p",[t._v("The first step is to create a service account in Google that will be in charge of uploading the images.")]),t._v(" "),a("p",[t._v("Navigate to "),a("a",{attrs:{href:"https://console.cloud.google.com/apis/credentials",target:"_blank",rel:"noopener noreferrer"}},[t._v("API's and Services, Credentials"),a("OutboundLink")],1),t._v(", and click "),a("strong",[t._v("CREATE CREDENTIALS")]),t._v(" Service account")]),t._v(" "),a("p",[a("img",{attrs:{src:s(396),alt:"service account create"}})]),t._v(" "),a("p",[t._v("Create the service account id, and leave everything else as default.")]),t._v(" "),a("p",[t._v("Next, we need to generate a Key that we will store with our project, to let google know that the service account is the one accessing the Bucket. Click on the newly created service account, and go to the "),a("strong",[t._v("KEYS")]),t._v(" tab.")]),t._v(" "),a("p",[t._v("Click ADD KEY / Create new key, and select JSON as the key type. Save this file in the root of your project (next to package.json).")]),t._v(" "),a("p",[a("img",{attrs:{src:s(397),alt:"create key"}})]),t._v(" "),a("p",[t._v("Finally, we will need to go back to our Cloud Storage Bucket, and grant permissions on our new service account to create objects.")]),t._v(" "),a("p",[t._v("In the Cloud Storage / Buckets page, click on the Bucket you created earlier and select the "),a("strong",[t._v("PERMISSIONS")]),t._v(" tab. Click "),a("strong",[t._v("GRANT ACCESS")]),t._v(", select the new service account as the "),a("em",[t._v("New prinicipal")]),t._v(" I find this UX hard, start typing the id of the service account you created, and it should auto complete.")]),t._v(" "),a("p",[a("img",{attrs:{src:s(398),alt:"grant access"}})]),t._v(" "),a("p",[t._v("Click save, and we should be done in the Google Dashboard.")]),t._v(" "),a("h4",{attrs:{id:"connecting-to-node-js"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#connecting-to-node-js"}},[t._v("#")]),t._v(" Connecting to Node.js")]),t._v(" "),a("p",[t._v("In a previous week, we talked about using "),a("a",{attrs:{href:"https://www.npmjs.com/package/multer",target:"_blank",rel:"noopener noreferrer"}},[t._v("multer"),a("OutboundLink")],1),t._v(" to attach file data to the request object in express. We will use this again here in combination with google's own package "),a("a",{attrs:{href:"https://www.npmjs.com/package/@google-cloud/storage",target:"_blank",rel:"noopener noreferrer"}},[t._v("@google-cloud/storage"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("Let's install both of these dependencies")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" multer @google-cloud/storage\n")])])]),a("p",[t._v("Let's create a middleware function using multer to look for an array of images.")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// src/middlewares/attachImages.js")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" multer "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"multer"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// we are looking for the property name `images`")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" attachImages "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("multer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("array")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"images"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nmodule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" attachImages"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("We will add this as middleware to any route that may involve a photo.")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// src/routers/cars.js")]),t._v("\n\ncarRouter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("post")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" attachImages"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" sanitizeBody"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" validateCarData"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" carController"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("create"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\ncarRouter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("put")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/:id'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" attachImages"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" sanitizeBody"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" validateCarData"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" carController"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("update"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\ncarRouter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("patch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/:id'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" attachImages"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" sanitizeBody"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" carController"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("update"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[t._v("sanitizeBody must be called after attachImages")]),t._v(" "),a("p",[t._v("We are using multer to add the form data to the request body. Until multer is run, req.body is an empty object when passed as form data (rather than JSON).")])]),t._v(" "),a("p",[t._v("Next, let's update our car model to have an "),a("code",[t._v("images")]),t._v(" array. This will be an array of urls (String) that we will generate after uploading the file to Google Storage.")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// src/models/car.js")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" carSchema "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("mongoose"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Schema")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("make")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("type")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" String"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("minLength")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("maxLength")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("model")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("type")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" String"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("minLength")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("maxLength")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("colour")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("type")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" String"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("minLength")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("maxLength")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("images")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("type")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("String"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("validate")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("urls")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" urls"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Please provide at least one image"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("owner")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("type")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" mongoose"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Schema"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Types"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ObjectId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("ref")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"User"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("required")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("timestamps")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("Custom Validation")]),t._v(" "),a("p",[t._v("We can create our own custom validation in mongoose using the "),a("code",[t._v("validate")]),t._v(" property. It takes an array of length 2, where the first element is a validation function (returns true if valid, false if not), and an error message in the second element.")])]),t._v(" "),a("p",[t._v("Next, we will pass the image data from the "),a("code",[t._v("req.files")]),t._v(" property from the controller to the car service.")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// src/controllers/cars.js")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("create")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" data "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" crapService"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("create")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("input"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("owner")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_id "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("files\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("json")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" data "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Let's create a new service just for handling uploading images to Google Storage. We will call it imageService, and for now, it will have one function called "),a("code",[t._v("uploadMany")]),t._v(".")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// src/services/images.js")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Storage "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"@google-cloud/storage"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" BadRequestError "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"../utils/index.js"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" storage "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Storage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("keyFilename")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" process"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("GOOGLE_STORAGE_SECRET_PATH")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" bucket "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" storage"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("bucket")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("proces"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("GOOGLE_STORAGE_BUCKET_NAME")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("uploadMany")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("files "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v("\n  Promise"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("all")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    files"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("map")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" originalname"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" buffer "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Prefix the filename with the current timestamp in milliseconds to allow duplcate file names to be saved.")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" filename "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("Date"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("originalname"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" blob "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" bucket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" blobStream "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" blob"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createWriteStream")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("resumable")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// write streams emit different events depending on the status of the file.")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// we will want to handle the `error` and `finish` events")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// since we don't know how long the file upload will take,")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// we will create a Promise, and either `resovle` the promise")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// with the uploaded image url if it is successful,")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// or `reject` the promise with an error")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// if we receive an `error` event from the WriteStream.")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" url "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Promise")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("resolve"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" reject")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// we define our event handlers first")]),t._v("\n        blobStream"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"error"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("err")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("reject")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BadRequestError")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("message"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        blobStream"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"finish"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// this is the format of the public url created in Cloud Storage")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("https://storage.googleapis.com/")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("bucket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("/")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("blob"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// then start the upload, and allow the event handlers created above to run")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// when the upload is complete / errors out")]),t._v("\n        blobStream"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("buffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" url"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nmodule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  uploadMany"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[t._v("Don't forget to update `.env` and `.env.example`")]),t._v(" "),a("p",[t._v("We will store the Bucket name and credential path in .env because it may change depending on the env.")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("GOOGLE_STORAGE_SECRET_PATH")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("storageKey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("json\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("GOOGLE_STORAGE_BUCKET_NAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("s2024"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("cars\n")])])])]),t._v(" "),a("p",[t._v("Finally, we will call "),a("code",[t._v("imageService.uploadMany")]),t._v(" from the car service, and save the generated urls in mongoose!.")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// src/services/cars.js")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("create")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" files")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" newCar "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Car")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" urls "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" imageService"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uploadMany")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("files"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  newCar"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("images "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" urls"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" newCar"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("save")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" newCar"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Test with Postman.")]),t._v(" "),a("p",[a("img",{attrs:{src:s(399),alt:"postman test"}})]),t._v(" "),a("h2",{attrs:{id:"additional-resources-for-the-final-project"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#additional-resources-for-the-final-project"}},[t._v("#")]),t._v(" Additional resources for the final project:")]),t._v(" "),a("ul",[a("li",[t._v("Search by location using mongodb "),a("a",{attrs:{href:"https://www.mongodb.com/docs/manual/reference/operator/query/near/",target:"_blank",rel:"noopener noreferrer"}},[t._v("$near"),a("OutboundLink")],1),t._v(" keyword.")]),t._v(" "),a("li",[t._v("Creating a "),a("code",[t._v("Point")]),t._v(" location type, and "),a("code",[t._v("2dsphere")]),t._v(" index with "),a("a",{attrs:{href:"https://mongoosejs.com/docs/geojson.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("mongoose"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://www.mongodb.com/docs/manual/reference/operator/query/regex/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Regexp search"),a("OutboundLink")],1),t._v(" with mongodb.")]),t._v(" "),a("li",[t._v("Using "),a("a",{attrs:{href:"https://mongoosejs.com/docs/tutorials/lean.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("lean"),a("OutboundLink")],1),t._v(" to convert mongoose object to javascript object.")]),t._v(" "),a("li",[t._v("Field selection in mongoose "),a("a",{attrs:{href:"https://mongoosejs.com/docs/populate.html#field-selection",target:"_blank",rel:"noopener noreferrer"}},[t._v("populate"),a("OutboundLink")],1)])]),t._v(" "),a("h2",{attrs:{id:"introducing-the-final-project"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#introducing-the-final-project"}},[t._v("#")]),t._v(" Introducing the Final Project")]),t._v(" "),a("p",[t._v("Instructions can be found "),a("RouterLink",{attrs:{to:"/deliverables/final.html"}},[t._v("here")])],1)],1)}),[],!1,null,null,null);a.default=n.exports}}]);